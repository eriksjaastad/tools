# Gemini Handoff: MCP Communication Setup

> **Purpose:** Four prompts for Gemini to complete the Agent Hub MCP communication setup
> **Context:** Claude diagnosed the architecture; these are the remaining fixes
> **Date:** 2026-01-18

---

## Background Context (Read This First)

The Agent Hub uses MCP (Model Context Protocol) servers for communication:
- `claude-mcp/` - Node.js server with hub tools + Claude tools
- `ollama-mcp/` - Node.js server with Ollama/worker tools

Both are **already built** (`dist/` folders exist). The remaining issues are:
1. Hub tools missing from `tools/list` response in `claude-mcp`
2. Hook script has `jq` dependency
3. Need end-to-end test
4. Cursor MCP config needs to be documented (user applies externally)

---

## Prompt 1: Fix tools/list Response in claude-mcp ✅ COMPLETE

**Objective:** Add the hub tools to the `tools/list` JSON-RPC response so MCP clients can discover them.

**Target File:** `claude-mcp/src/server.ts`

**Status:** Completed and verified 2026-01-18

**Acceptance Criteria:**
- [x] All 13 tools listed in `tools/list` response
- [x] Each tool has a name and description
- [x] Server still compiles: `npm run build` in `claude-mcp/`
- [x] Test passes: `echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | node dist/server.js`

**Verified Tools:**
1. claude_judge_review
2. request_draft_review
3. submit_review_verdict
4. claude_validate_proposal
5. claude_security_audit
6. claude_resolve_conflict
7. claude_health
8. hub_connect
9. hub_send_message
10. hub_receive_messages
11. hub_heartbeat
12. hub_send_answer
13. hub_get_all_messages

---

## Prompt 2: Remove jq Dependency from Hook Script ✅ COMPLETE

**Objective:** Rewrite the Cursor hook script to not require `jq`.

**Target File:** `agent-hub/.cursor/hooks/floor_manager_pickup.sh`

**Status:** Completed and verified 2026-01-18

**Acceptance Criteria:**
- [x] Script does NOT use `jq` (uses Node.js instead)
- [x] Script is executable (`chmod +x`) - permissions: `-rwxr-xr-x`
- [x] Handles the same cases as current script
- [x] Add a comment noting why we don't use `jq` (line 4)

**Verification Tests:**
```
$ echo '{"file_path":"_handoff/TASK_test.md"}' | ./floor_manager_pickup.sh
→ Returns followup_message ✅

$ echo '{"file_path":"src/other.py"}' | ./floor_manager_pickup.sh
→ Returns {} ✅

$ echo '{}' | ./floor_manager_pickup.sh
→ Returns {} ✅
```

---

## Prompt 3: Create End-to-End Test Script ✅ COMPLETE

**Objective:** Create a test script that validates the full communication flow.

**Target File:** `agent-hub/scripts/test_mcp_communication.py`

**Status:** Completed and verified 2026-01-18

**Acceptance Criteria:**
- [x] Script runs with: `python3 scripts/test_mcp_communication.py`
- [x] Uses subprocess to spawn Node servers (`MCPServerProcess` class)
- [x] Cleans up after itself (kills subprocesses, removes `hub_state.json`)
- [x] Exits with code 0 on success, 1 on failure
- [x] Has `--verbose` flag for debugging

**Test Results:**
```
=== MCP Communication E2E Test ===
[PASS] claude-mcp: tools/list returns 13 tools
[PASS] claude-mcp: hub_connect successful
[PASS] claude-mcp: hub_send_message successful
[PASS] claude-mcp: hub_receive_messages returns empty list
[PASS] claude-mcp: hub_state.json created
[PASS] ollama-mcp: tools/list returns 8 tools
[PASS] hook: floor_manager_pickup.sh triggers on TASK file
=== 7/7 tests passed ===
```

---

## Prompt 4: Document Cursor MCP Configuration ✅ COMPLETE

**Objective:** Create a setup guide for configuring Cursor to use the MCP servers.

**Target File:** `agent-hub/Documents/CURSOR_MCP_SETUP.md`

**Status:** Completed and verified 2026-01-18

**Acceptance Criteria:**
- [x] File exists at `agent-hub/Documents/CURSOR_MCP_SETUP.md`
- [x] Uses placeholder `<ABSOLUTE_PATH>` that user can replace
- [x] Includes verification steps (Section 3)
- [x] Documents the Anti-Gravity limitation (Section 5)

**Document Sections:**
1. MCP Server Configuration (JSON template)
2. Where to Apply This Config (Cursor settings location)
3. Verification Steps (test commands)
4. Troubleshooting (common issues)
5. Important Notes (Anti-Gravity limitation)

---

## Verification Commands

After all prompts are complete, run:

```bash
# 1. Verify claude-mcp tools/list
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | node claude-mcp/dist/server.js

# 2. Verify hook script works without jq
echo '{"file_path":"_handoff/TASK_test.md"}' | agent-hub/.cursor/hooks/floor_manager_pickup.sh

# 3. Run E2E test
cd agent-hub && python scripts/test_mcp_communication.py --verbose

# 4. Check documentation exists
cat agent-hub/Documents/CURSOR_MCP_SETUP.md
```

---

*Generated by Claude for Gemini handoff - 2026-01-18*
